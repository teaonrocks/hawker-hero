<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title><%= title %></title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet"
		/>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
			rel="stylesheet"
		/>
	</head>
	<body>
		<%- include('partials/navbar') %> <%- include('partials/flash-messages') %>

		<div class="container mt-4">
			<div class="row">
				<div class="col-12">
					<h1 class="mb-4"><i class="bi bi-building"></i> Hawker Centers</h1>

					<!-- Admin Controls -->
					<% if (user && user.role === 'admin') { %>
					<div class="row mb-4">
						<div class="col-12">
							<button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCenterModal">
								<i class="bi bi-plus"></i> Add New Hawker Center
							</button>
						</div>
					</div>
					<% } %>

					<!-- Search and Filter Bar -->
					<form method="GET" action="/hawker-centers" class="mb-4">
						<div class="row">
							<div class="col-md-6">
								<div class="input-group">
									<input
										type="text"
										name="search"
										class="form-control"
										placeholder="Search hawker centers..."
										value="<%= filters.search %>"
									/>
									<button class="btn btn-primary" type="submit">
										<i class="bi bi-search"></i>
									</button>
								</div>
							</div>
							<div class="col-md-4">
								<select name="facilities" class="form-select">
									<option value="">All Facilities</option>
									<option value="Air-conditioned" <%= filters.facilities === 'Air-conditioned' ? 'selected' : '' %>>Air-conditioned</option>
									<option value="WiFi" <%= filters.facilities === 'WiFi' ? 'selected' : '' %>>WiFi</option>
									<option value="Parking" <%= filters.facilities === 'Parking' ? 'selected' : '' %>>Parking</option>
									<option value="Toilets" <%= filters.facilities === 'Toilets' ? 'selected' : '' %>>Toilets</option>
								</select>
							</div>
							<div class="col-md-2">
								<button type="submit" class="btn btn-outline-primary w-100">Filter</button>
							</div>
						</div>
					</form>

					<!-- Centers List -->
					<div class="row">
						<% if (centers && centers.length > 0) { %>
							<% centers.forEach(center => { %>
							<div class="col-md-6 mb-4">
								<div class="card">
									<% if (center.image_url) { %>
									<img src="/images/<%= center.image_url %>" class="card-img-top" style="height: 200px; object-fit: cover;" alt="<%= center.name %>">
									<% } else { %>
									<div
										class="card-img-top bg-light d-flex align-items-center justify-content-center"
										style="height: 200px"
									>
										<i class="bi bi-image text-muted" style="font-size: 3rem"></i>
									</div>
									<% } %>
									<div class="card-body">
										<div class="d-flex justify-content-between align-items-start mb-2">
											<h5 class="card-title"><%= center.name %></h5>
											<% if (user && user.role === 'admin') { %>
											<div class="dropdown">
												<button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
													<i class="bi bi-three-dots"></i>
												</button>
												<ul class="dropdown-menu">
													<li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editCenterModal<%= center.id %>"><i class="bi bi-pencil"></i> Edit</a></li>
													<li><a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteCenterModal<%= center.id %>"><i class="bi bi-trash"></i> Delete</a></li>
												</ul>
											</div>
											<% } %>
										</div>
										<p class="card-text">
											<i class="bi bi-geo-alt text-primary"></i>
											<%= center.address %>
										</p>
										<% if (center.facilities) { %>
										<div class="mb-2">
											<% const facilityList = center.facilities.split(','); %>
											<% facilityList.forEach(facility => { %>
												<% const trimmedFacility = facility.trim(); %>
												<% let badgeClass = 'bg-secondary'; %>
												<% if (trimmedFacility === 'Air-conditioned') badgeClass = 'bg-success'; %>
												<% if (trimmedFacility === 'WiFi') badgeClass = 'bg-info'; %>
												<% if (trimmedFacility === 'Parking') badgeClass = 'bg-warning'; %>
												<% if (trimmedFacility === 'Toilets') badgeClass = 'bg-primary'; %>
												<span class="badge <%= badgeClass %> me-1"><%= trimmedFacility %></span>
											<% }); %>
										</div>
										<% } %>
										<div
											class="d-flex justify-content-between align-items-center"
										>
											<small class="text-muted"><%= center.stall_count || 0 %> stalls</small>
											<a href="/stalls?center=<%= center.id %>" class="btn btn-primary btn-sm">View Stalls</a>
										</div>
									</div>
								</div>
							</div>
							<% }); %>
						<% } else { %>
						<!-- Empty state -->
						<div class="col-12 text-center py-5">
							<i class="bi bi-building text-muted" style="font-size: 4rem"></i>
							<h4 class="mt-3 text-muted">No hawker centers found</h4>
							<p class="text-muted">
								<% if (filters.search || filters.facilities) { %>
									Try adjusting your search filters.
								<% } else { %>
									Check back later for new centers!
								<% } %>
							</p>
						</div>
						<% } %>
					</div>
				</div>
			</div>
		</div>

		<!-- Add Center Modal -->
		<% if (user && user.role === 'admin') { %>
		<div class="modal fade" id="addCenterModal" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Add New Hawker Center</h5>
						<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
					</div>
					<form action="/hawker-centers/add" method="POST" enctype="multipart/form-data">
						<div class="modal-body">
							<div class="mb-3">
								<label for="name" class="form-label">Name *</label>
								<input type="text" class="form-control" id="name" name="name" required>
							</div>
							<div class="mb-3">
								<label for="address" class="form-label">Address *</label>
								<input type="text" class="form-control" id="address" name="address" required>
							</div>
							<div class="mb-3">
								<label for="facilities" class="form-label">Facilities</label>
								<input type="text" class="form-control" id="facilities" name="facilities" placeholder="e.g., Air-conditioned, WiFi, Parking">
								<div class="form-text">Separate multiple facilities with commas</div>
							</div>
							<div class="mb-3">
								<label for="image" class="form-label">Image</label>
								<input type="file" class="form-control" id="image" name="image" accept="image/*">
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" class="btn btn-success">Add Center</button>
						</div>
					</form>
				</div>
			</div>
		</div>

		<!-- Edit Center Modals -->
		<% if (centers && centers.length > 0) { %>
			<% centers.forEach(center => { %>
			<div class="modal fade" id="editCenterModal<%= center.id %>" tabindex="-1">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Edit Hawker Center</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<form action="/hawker-centers/edit/<%= center.id %>" method="POST" enctype="multipart/form-data">
							<div class="modal-body">
								<div class="mb-3">
									<label for="editName<%= center.id %>" class="form-label">Name *</label>
									<input type="text" class="form-control" id="editName<%= center.id %>" name="name" value="<%= center.name %>" required>
								</div>
								<div class="mb-3">
									<label for="editAddress<%= center.id %>" class="form-label">Address *</label>
									<input type="text" class="form-control" id="editAddress<%= center.id %>" name="address" value="<%= center.address %>" required>
								</div>
								<div class="mb-3">
									<label for="editFacilities<%= center.id %>" class="form-label">Facilities</label>
									<input type="text" class="form-control" id="editFacilities<%= center.id %>" name="facilities" value="<%= center.facilities || '' %>" placeholder="e.g., Air-conditioned, WiFi, Parking">
									<div class="form-text">Separate multiple facilities with commas</div>
								</div>
								<div class="mb-3">
									<label for="editImage<%= center.id %>" class="form-label">Image</label>
									<% if (center.image_url) { %>
									<div class="mb-2">
										<img src="/images/<%= center.image_url %>" class="img-thumbnail" style="max-width: 100px;">
										<div class="form-text">Current image</div>
									</div>
									<% } %>
									<input type="file" class="form-control" id="editImage<%= center.id %>" name="image" accept="image/*">
									<div class="form-text">Leave empty to keep current image</div>
								</div>
							</div>
							<div class="modal-footer">
								<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
								<button type="submit" class="btn btn-primary">Update Center</button>
							</div>
						</form>
					</div>
				</div>
			</div>

			<!-- Delete Center Modal -->
			<div class="modal fade" id="deleteCenterModal<%= center.id %>" tabindex="-1">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">Delete Hawker Center</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<p>Are you sure you want to delete "<%= center.name %>"?</p>
							<p class="text-danger small">This action cannot be undone. You must remove all associated stalls first.</p>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
							<form action="/hawker-centers/delete/<%= center.id %>" method="POST" style="display: inline;">
								<button type="submit" class="btn btn-danger">Delete Center</button>
							</form>
						</div>
					</div>
				</div>
			</div>
			<% }); %>
		<% } %>
		<% } %>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	</body>
</html>
